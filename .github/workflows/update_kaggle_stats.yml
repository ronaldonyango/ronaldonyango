name: Update Kaggle Stats in README

on:
  schedule:
    # Runs every 6 hours (at 15 minutes past the hour)
    - cron: '15 */6 * * *'
  workflow_dispatch:

env:
  KAGGLE_API_TOKEN: ${{ secrets.KAGGLE_API_TOKEN }}
  PYTHON_VERSION: '3.10'
  PYTHON_CACHE_VERSION: '3.10'

jobs:
  update_kaggle_stats:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.PYTHON_CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.PYTHON_CACHE_VERSION }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get Kaggle dataset stats
        id: dataset_stats
        run: python scripts/update_kaggle_stats.py
        env:
          GITHUB_OUTPUT: ${{ github.outputs }}

      - name: Update README
        run: python scripts/update_readme.py
        env:
          STATS: ${{ env.STATS}}

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ðŸ“Š Updated Kaggle dataset stats [skip ci]"
          branch: master
